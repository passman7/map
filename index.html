<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>ëŒ€êµ¬ ë‹´ë°°ì†Œë§¤ì  ì§€ë„ (ì¹´ì¹´ì˜¤)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    * { box-sizing: border-box; font-family: sans-serif; }
    body {
      margin: 0;
      display: flex;
      height: 100vh;
      flex-direction: row;
    }
    #sidebar {
      width: 300px;
      background: #f7f7f7;
      padding: 10px;
      overflow-y: auto;
      border-right: 1px solid #ddd;
    }
    #map {
      flex: 1;
      height: 100%;
    }
    .store-item {
      background: white;
      margin-bottom: 10px;
      padding: 8px;
      border-radius: 6px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }
    .store-item:hover {
      background: #eaeaea;
      cursor: pointer;
    }
    .popup {
      padding: 8px;
      width: 200px;
    }
    .popup textarea {
      width: 100%;
      height: 60px;
    }
    .popup button {
      margin-top: 5px;
      margin-right: 5px;
    }
    select, input[type="text"], button {
      width: 100%;
      padding: 6px;
      margin: 4px 0;
    }

    @media (max-width: 768px) {
      body {
        flex-direction: column;
      }
      #sidebar {
        width: 100%;
        height: 250px;
        border-right: none;
        border-bottom: 1px solid #ddd;
      }
      #map {
        height: calc(100vh - 250px);
      }
    }
  </style>
  <script src="https://dapi.kakao.com/v2/maps/sdk.js?appkey=d7e491600cda23ba800b2265c04daa63&autoload=false&libraries=clusterer"></script>
</head>
<body>
  <div id="sidebar">
    <input type="text" id="search" placeholder="ì‚¬ì—…ì¥ëª… ê²€ìƒ‰">
    <select id="yearFilter"><option value="all">ì „ì²´ ì—°ë„</option></select>
    <select id="typeFilter"><option value="all">ì „ì²´ êµ¬ë¶„</option></select>
    <button onclick="showMyLocation()">ğŸ“ ë‚´ ìœ„ì¹˜ ë³´ê¸°</button>
    <div id="storeList"></div>
  </div>
  <div id="map"></div>

  <script>
    kakao.maps.load(() => {
      const mapContainer = document.getElementById('map');
      const map = new kakao.maps.Map(mapContainer, {
        center: new kakao.maps.LatLng(35.8714, 128.6014),
        level: 6
      });

      const clusterer = new kakao.maps.MarkerClusterer({
        map: map,
        averageCenter: true,
        minLevel: 6
      });

      let allData = [];
      let allMarkers = [];
      let infowindow = null;
      let myMarker = null;

      fetch("store_data.json")
        .then(res => res.json())
        .then(data => {
          allData = data;
          renderFilters(data);
        });

      function renderFilters(data) {
        const yearSet = new Set();
        const typeSet = new Set();
        data.forEach(d => {
          if (d['ì¸í—ˆê°€ì¼ì']) yearSet.add(d['ì¸í—ˆê°€ì¼ì'].substring(0, 4));
          if (d['êµ¬ë¶„']) typeSet.add(d['êµ¬ë¶„']);
        });

        const yearFilter = document.getElementById("yearFilter");
        [...yearSet].sort().forEach(y => {
          const o = document.createElement("option");
          o.value = y;
          o.text = y;
          yearFilter.appendChild(o);
        });

        const typeFilter = document.getElementById("typeFilter");
        [...typeSet].sort().forEach(t => {
          const o = document.createElement("option");
          o.value = t;
          o.text = t;
          typeFilter.appendChild(o);
        });

        document.getElementById("search").addEventListener("input", applyFilters);
        yearFilter.addEventListener("change", applyFilters);
        typeFilter.addEventListener("change", applyFilters);
      }

      function applyFilters() {
        const keyword = document.getElementById("search").value.trim();
        const year = document.getElementById("yearFilter").value;
        const type = document.getElementById("typeFilter").value;

        const filtered = allData.filter(d => {
          const matchName = !keyword || d['ì‚¬ì—…ì¥ëª…']?.includes(keyword);
          const matchYear = year === "all" || d['ì¸í—ˆê°€ì¼ì']?.startsWith(year);
          const matchType = type === "all" || d['êµ¬ë¶„'] === type;
          return matchName && matchYear && matchType;
        });

        renderMap(filtered);
      }

      function renderMap(data) {
        clusterer.clear();
        allMarkers.forEach(m => m.setMap(null));
        allMarkers = [];

        const storeList = document.getElementById("storeList");
        storeList.innerHTML = "";

        if (data.length === 0) {
          storeList.innerHTML = "<div style='padding:5px; color:gray;'>ğŸ” ì¡°ê±´ì— ë§ëŠ” ì—…ì†Œê°€ ì—†ìŠµë‹ˆë‹¤.</div>";
          return;
        }

        storeList.insertAdjacentHTML("afterbegin", `<div style="padding:5px; color:#333;">ğŸ” ì´ ${data.length}ê°œ ì—…ì†Œ</div>`);

        data.forEach(store => {
          const marker = new kakao.maps.Marker({
            position: new kakao.maps.LatLng(store.lat, store.lon)
          });

          const savedMemo = localStorage.getItem(store.lat + "," + store.lon) || "";

          const content = document.createElement("div");
          content.className = "popup";
          content.innerHTML = `
            <div><strong>${store['ì‚¬ì—…ì¥ëª…']}</strong><br>${store['ì¸í—ˆê°€ì¼ì']}</div>
            <textarea>${savedMemo}</textarea><br>
            <button onclick="saveMemo('${store.lat}', '${store.lon}', this)">ğŸ’¾ ì €ì¥</button>
            <button onclick="deleteMemo('${store.lat}', '${store.lon}', this)">âŒ ì‚­ì œ</button>
          `;

          kakao.maps.event.addListener(marker, 'click', function() {
            if (infowindow) infowindow.close();
            infowindow = new kakao.maps.InfoWindow({ content });
            infowindow.open(map, marker);
          });

          allMarkers.push(marker);

          const item = document.createElement("div");
          item.className = "store-item";
          item.textContent = `${store['ì‚¬ì—…ì¥ëª…']} (${store['ì¸í—ˆê°€ì¼ì']})`;
          item.onclick = () => map.panTo(marker.getPosition());
          storeList.appendChild(item);
        });

        clusterer.addMarkers(allMarkers);

        kakao.maps.event.addListener(map, 'click', function() {
          if (infowindow) infowindow.close();
        });
      }

      window.saveMemo = function(lat, lon, el) {
        const memo = el.parentElement.querySelector("textarea").value;
        localStorage.setItem(lat + "," + lon, memo);
        alert("ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.");
      }

      window.deleteMemo = function(lat, lon, el) {
        localStorage.removeItem(lat + "," + lon);
        el.parentElement.querySelector("textarea").value = "";
        alert("ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.");
      }

      window.showMyLocation = function () {
        if (!navigator.geolocation) {
          alert("í˜„ì¬ ìœ„ì¹˜ë¥¼ ì§€ì›í•˜ì§€ ì•ŠëŠ” ë¸Œë¼ìš°ì €ì…ë‹ˆë‹¤.");
          return;
        }

        navigator.geolocation.getCurrentPosition(pos => {
          const lat = pos.coords.latitude;
          const lon = pos.coords.longitude;
          const loc = new kakao.maps.LatLng(lat, lon);

          map.setCenter(loc);
          map.setLevel(5);

          if (myMarker) myMarker.setMap(null);
          myMarker = new kakao.maps.Marker({
            position: loc,
            map: map,
            title: "ë‚´ ìœ„ì¹˜",
            image: new kakao.maps.MarkerImage(
              "https://t1.daumcdn.net/localimg/localimages/07/mapapidoc/red_b.png",
              new kakao.maps.Size(64, 69),
              { offset: new kakao.maps.Point(27, 69) }
            )
          });
        }, err => {
          alert("ìœ„ì¹˜ ì •ë³´ë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
        });
      }
    });
  </script>
</body>
</html>
